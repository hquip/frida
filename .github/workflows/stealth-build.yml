name: Stealth Build

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-ios:
    runs-on: macos-latest
    env:
      IOS_CERTID: "-"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          brew install wget dos2unix
          pip3 install colorama prompt-toolkit pygments

      - name: Fix line endings
        run: |
          find . -type f \( -name "configure" -o -name "*.sh" \) -exec dos2unix {} + || true
          chmod +x configure

      - name: Configure for iOS
        run: |
          ./configure --host=ios-arm64

      - name: Build
        run: |
          make

      - name: List build directory
        run: ls -R build || true

      - name: Package Release
        run: |
          mkdir -p release
          # Find server binary (executable, in server directory, likely no extension)
          find build -type f -path "*/server/*" ! -name "*.*" -exec cp {} release/ \;
          # Find agent (dylib)
          find build -type f -path "*/agent/*.dylib" -exec cp {} release/ \;
          echo "Release contents:"
          ls -R release

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-android:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential curl git lib32stdc++-9-dev libc6-dev-i386 nodejs npm dos2unix
          pip3 install colorama prompt-toolkit pygments

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup NDK
        uses: android-actions/setup-android@v3
      - name: Install NDK
        run: |
          sdkmanager --install "ndk;25.2.9519653"
          echo "ANDROID_NDK_ROOT=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV

      - name: Fix line endings
        run: |
          find . -type f \( -name "configure" -o -name "*.sh" \) -exec dos2unix {} + || true
          chmod +x configure

      - name: Configure for Android
        run: |
          ./configure --host=android-arm64

      - name: Build
        run: |
          make

      - name: Package Release
        run: |
          mkdir -p release
          # Find server binary (executable, in server directory, likely no extension)
          find build -type f -path "*/server/*" ! -name "*.*" -exec cp {} release/ \;
          # Find agent (so)
          find build -type f -path "*/agent/*.so" -exec cp {} release/ \;
          echo "Release contents:"
          ls -R release

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
