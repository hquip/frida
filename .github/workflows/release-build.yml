name: Build Frida (Stealth)

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          brew install wget
          pip3 install colorama prompt-toolkit pygments

      - name: Check Submodules and Patches
        run: |
          git submodule status
          ls -R patches/

      - name: Apply Stealth Patches
        run: |
          # Define apply function for consistency
          apply_patch() {
            patch_file="$1"
            target_dir="$2"
            echo "Applying $patch_file to $target_dir..."
            # Resolve absolute path for patch file if it starts with ../
            if [[ "$patch_file" == ../* ]]; then
               # Assuming we are in subprojects/frida-core or gum, so ../../patches is correct relative to CWD
               # But to be safe, let's use the full path from root
               # actually, let's just use the relative path as passed, assuming CWD is correct
               :
            fi

            if [ -f "$patch_file" ]; then
              if [ "$target_dir" != "." ]; then
                cd "$target_dir"
              fi
              
              # Try applying with git apply, falling back to patch if needed, or ignoring whitespace
              git apply --verbose --ignore-space-change --whitespace=fix "$patch_file" || {
                echo "Error applying $patch_file"
                exit 1
              }
              
              if [ "$target_dir" != "." ]; then
                cd - > /dev/null
              fi
            else
              echo "Patch file $patch_file not found!"
              exit 1
            fi
          }

          # Apply root patch
          apply_patch "patches/root.patch" "."
          
          # Apply frida-core patch
          apply_patch "../../patches/frida-core.patch" "subprojects/frida-core"
          
          # Apply frida-gum patch
          apply_patch "../../patches/frida-gum.patch" "subprojects/frida-gum"
          
          echo "All patches applied successfully"

      - name: Configure for iOS
        run: |
          export IOS_CERT_ID=""
          ./configure --host=ios-arm64

      - name: Build
        run: |
          make core

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frida-ios-binaries
          path: |
            build/frida-ios-arm64/lib/agent/frida-agent.dylib
            build/frida-ios-arm64/server/frida-server

  build-android:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential curl git lib32stdc++-9-dev libc6-dev-i386 nodejs npm
          pip3 install colorama prompt-toolkit pygments

      - name: Setup NDK
        uses: android-actions/setup-android@v3
      - name: Install NDK
        run: |
          sdkmanager --install "ndk;25.2.9519653"
          echo "ANDROID_NDK_ROOT=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV

      - name: Check Submodules and Patches
        run: |
          git submodule status
          ls -R patches/

      - name: Apply Stealth Patches
        run: |
          apply_patch() {
            patch_file="$1"
            target_dir="$2"
            echo "Applying $patch_file to $target_dir..."
            if [ -f "$patch_file" ]; then
              if [ "$target_dir" != "." ]; then
                cd "$target_dir"
              fi
              git apply --verbose --ignore-space-change --whitespace=fix "$patch_file" || {
                echo "Error applying $patch_file"
                exit 1
              }
              if [ "$target_dir" != "." ]; then
                cd - > /dev/null
              fi
            else
              echo "Patch file $patch_file not found!"
              exit 1
            fi
          }

          apply_patch "patches/root.patch" "."
          apply_patch "../../patches/frida-core.patch" "subprojects/frida-core"
          apply_patch "../../patches/frida-gum.patch" "subprojects/frida-gum"

      - name: Configure for Android
        run: |
          ./configure --host=android-arm64

      - name: Build
        run: |
          make core

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frida-android-binaries
          path: |
            build/frida-android-arm64/lib/agent/libfrida-agent-raw.so
            build/frida-android-arm64/server/frida-server

  release:
    needs: [build-ios, build-android]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download iOS Artifacts
        uses: actions/download-artifact@v4
        with:
          name: frida-ios-binaries
          path: ios

      - name: Download Android Artifacts
        uses: actions/download-artifact@v4
        with:
          name: frida-android-binaries
          path: android

      - name: Rename Android Server
        run: mv android/frida-server android/fs-server

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ios/frida-server
            ios/frida-agent.dylib
            android/fs-server
            android/libfrida-agent-raw.so
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
